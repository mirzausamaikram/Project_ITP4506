<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales Dashboard â€“ Smile and Sunshine Toys</title>
  <link rel="stylesheet" href="../css/main.css"/>
  <link rel="stylesheet" href="../css/animations.css"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Chart.js for small sales chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      body {
          background: linear-gradient(135deg, #fff 0%, #f0f8f8 100%);
          font-family: "Segoe UI", Arial, Helvetica, sans-serif;
          min-height: 100vh;
          padding-top: 65px;
      }
      .snowflake {
          position: fixed;
          top: -10px;
          color: rgba(255, 255, 255, 0.8);
          font-size: 1.5em;
          animation: snowfall linear infinite;
          pointer-events: none;
          z-index: 0;
      }
      @keyframes snowfall {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
      }
      .navbar {
          background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
          padding: 12px 0;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          width: 100%;
          z-index: 1000;
      }
      .navbar .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .navbar-brand {
          font-size: 1.3rem;
          font-weight: 700;
          color: #d32f2f;
          text-decoration: none;
          transition: all 0.3s ease;
      }
      .navbar-brand:hover {
          text-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
      }
      .navbar-nav {
          display: flex;
          gap: 25px;
          list-style: none;
      }
      .nav-item {
          color: #d32f2f;
          text-decoration: none;
          font-weight: 600;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          padding: 8px 12px;
          border-radius: 4px;
          position: relative;
      }
      .nav-item:hover {
          color: #ff6b6b;
          background: rgba(211, 47, 47, 0.1);
          transform: translateY(-2px);
      }
      .card {
          position: relative;
          z-index: 1;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
          max-width: 1100px !important;
          margin: 30px auto !important;
          padding: 40px !important;
      }
      .card h2 {
          color: #d32f2f;
          margin-bottom: 10px;
          font-size: 2rem;
          font-weight: 700;
      }
      .welcome-text {
          font-size: 1.1rem;
          color: #666;
          margin-bottom: 25px;
          padding-bottom: 15px;
          border-bottom: 2px solid #e8e8e8;
      }
      .welcome-text strong {
          color: #d32f2f;
          font-weight: 700;
      }
      .quotations-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 20px;
          margin: 25px 0;
      }
      .quotation-card {
          background: linear-gradient(135deg, #f9f9f9 0%, #fff 100%);
          border: 2px solid #e8e8e8;
          border-radius: 10px;
          padding: 20px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          cursor: pointer;
          position: relative;
          overflow: hidden;
      }
      .quotation-card:before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
          transition: left 0.5s ease;
      }
      .quotation-card:hover:before {
          left: 100%;
      }
      .quotation-card:hover {
          border-color: #d32f2f;
          box-shadow: 0 12px 24px rgba(211, 47, 47, 0.2);
          transform: translateY(-8px);
      }
      .quotation-card h3 {
          color: #d32f2f;
          font-size: 1.1rem;
          margin-bottom: 12px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      .quotation-card p {
          color: #666;
          font-size: 0.9rem;
          margin: 8px 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .quotation-card strong {
          color: #333;
      }
      .badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 600;
          background: #d32f2f;
          color: white;
      }
      .button-group {
          display: flex;
          gap: 12px;
          margin-top: 30px;
          justify-content: center;
          flex-wrap: wrap;
      }
      .btn {
          padding: 12px 24px;
          border: none;
          border-radius: 8px;
          background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
          color: white;
          cursor: pointer;
          font-weight: 600;
          font-size: 0.95rem;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          text-decoration: none;
          display: inline-block;
          text-align: center;
          flex: 1;
          min-width: 150px;
      }
      .btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 16px rgba(211, 47, 47, 0.3);
      }
      .stats-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin: 25px 0;
      }
      .stat-box {
          background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
      }
      .stat-box h4 {
          font-size: 2rem;
          font-weight: 700;
          margin-bottom: 8px;
      }
      .stat-box p {
          font-size: 0.9rem;
          opacity: 0.95;
      }
      .empty-state {
          text-align: center;
          padding: 40px 20px;
          color: #999;
      }
      .empty-state p {
          font-size: 1.1rem;
          margin-bottom: 20px;
      }
      /* compact widgets */
      .mini-widgets { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top:10px; }
      .mini-card { background:#fff; border-radius:8px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); text-align:center; }
      .mini-card h4 { margin:6px 0; color:#d32f2f; font-size:1.1rem; }
      .mini-card p { margin:0; font-weight:700; font-size:1.05rem; color:#333; }
      #salesChart { width:100%; height:140px; }
      .recent-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
      .recent-table th, .recent-table td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
      .note-item { background:#fff8f8; padding:8px; border-radius:6px; margin-bottom:8px; }
      .small-actions { display:flex; gap:8px; margin-top:12px; justify-content:center; flex-wrap:wrap; }
      .small-actions .btn { padding:8px 12px; min-width:120px; }
  </style>
</head>
<body>
  <!-- Falling snowflakes -->
  <script>
      function createSnowflakes() {
          for(let i = 0; i < 25; i++) {
              const snowflake = document.createElement('div');
              snowflake.className = 'snowflake';
              snowflake.textContent = 'â„';
              snowflake.style.left = Math.random() * window.innerWidth + 'px';
              snowflake.style.animationDuration = (Math.random() * 10 + 10) + 's';
              snowflake.style.animationDelay = Math.random() * 5 + 's';
              document.body.appendChild(snowflake);
          }
      }
      createSnowflakes();
  </script>

  <nav class="navbar">
      <div class="container">
          <a href="sales_dashboard.html" class="navbar-brand">ðŸŽ„ Smile & Sunshine Toys - Sales</a>
          <div class="navbar-nav">
              <a href="quotation_list.html" class="nav-item">Quotation List</a>
              <a href="order.html" class="nav-item">Order Management</a>
              <a href="#" onclick="logout(); return false;" class="nav-item">Logout</a>
          </div>
      </div>
  </nav>

  <div class="card">
    <h2>ðŸ“Š Sales Dashboard</h2>
    <div class="welcome-text">Welcome <strong id="userName"></strong>! ðŸŽ„</div>

    <!-- Enhanced widgets -->
    <div class="mini-widgets" id="statsContainer">
      <!-- filled by JS -->
    </div>

    <div style="display:grid; grid-template-columns:1fr 360px; gap:18px; margin-top:18px;">
      <div>
        <div class="mini-card" style="padding-bottom:8px;">
          <canvas id="salesChart"></canvas>
        </div>

        <div style="margin-top:12px; background:#fff; padding:8px; border-radius:8px; box-shadow:0 6px 12px rgba(0,0,0,0.04);">
          <h4 style="margin:0 0 8px 0;">Recent Orders</h4>
          <table class="recent-table" id="recentOrdersTable">
            <thead><tr><th>Order</th><th>Total</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="small-actions">
            <button class="btn" id="exportCsvBtn">Export Orders CSV</button>
            <a class="btn" href="order.html">Manage Orders â†’</a>
          </div>
        </div>
      </div>

      <div>
        <div class="mini-card">
          <h4>Quick Stats</h4>
          <p id="statTotalSales">HK$ 0</p>
          <div style="font-size:0.9rem;color:#666;margin-top:6px;">Total Sales</div>
        </div>
        <div style="margin-top:12px; background:#fff; padding:10px; border-radius:8px; box-shadow:0 6px 12px rgba(0,0,0,0.04);">
          <h4 style="margin:0 0 8px 0;">Recent Messages</h4>
          <div id="recentMessages"></div>
        </div>
      </div>
    </div>

    <div id="quotations" style="margin-top:18px;">
      <!-- Quotations will be listed here -->
    </div>

    <div class="button-group">
        <a class="btn" href="quotation_list.html">ðŸ“‹ View All Quotations</a>
        <a class="btn" href="order.html">ðŸ“¦ Manage Orders</a>
    </div>
  </div>
  

  <script src="../js/shared_data.js"></script>
  <script src="js/sales.js"></script>
  <script>
    function logout() {
      sessionStorage.removeItem('user');
      location.href = '../login.html';
    }
  </script>
  <script>
    // small helper
    const $ = (s)=>document.querySelector(s);
    const parseJSON = (k)=> { try { return JSON.parse(localStorage.getItem(k))||[] } catch(e){return []} };

    function renderStats() {
      const orders = parseJSON('orders');
      const totalSales = orders.reduce((s,o)=> s + (parseFloat(o.total)||0), 0);
      const totalOrders = orders.length;
      const pending = orders.filter(o=> (o.status||'').toLowerCase() === 'pending').length;
      const container = document.getElementById('statsContainer');
      container.innerHTML = `
        <div class="mini-card"><h4>Total Orders</h4><p>${totalOrders}</p></div>
        <div class="mini-card"><h4>Pending</h4><p>${pending}</p></div>
        <div class="mini-card"><h4>Average Order</h4><p>HK$ ${ (totalOrders? (totalSales/totalOrders).toFixed(2):'0.00') }</p></div>
        <div class="mini-card"><h4>Sales (all)</h4><p>HK$ ${ totalSales.toFixed(2) }</p></div>
      `;
      $('#statTotalSales').textContent = 'HK$ ' + totalSales.toFixed(2);
    }

    function renderRecentOrders() {
      const orders = parseJSON('orders').slice().reverse().slice(0,8);
      const tbody = document.querySelector('#recentOrdersTable tbody');
      if (!tbody) return;
      tbody.innerHTML = orders.map(o=>`
        <tr>
          <td>${o.id}</td>
          <td>HK$ ${(o.total||0).toFixed(2)}</td>
          <td>${ (o.status||'Pending') }</td>
        </tr>
      `).join('') || '<tr><td colspan="3" style="color:#999">No recent orders</td></tr>';
    }

    function renderMessages() {
      const orders = parseJSON('orders').slice().reverse().filter(o=> o.message).slice(0,6);
      const box = document.getElementById('recentMessages');
      box.innerHTML = orders.map(o=>`<div class="note-item"><strong>${o.id}</strong> <div style="color:#444; white-space:pre-wrap;">${(o.message||'').slice(0,200)}</div></div>`).join('') || '<div style="color:#999">No messages</div>';
    }

    // simple sales chart by month (counts)
    function renderChart() {
      const orders = parseJSON('orders');
      // last 6 months labels
      const labels = [];
      const data = [];
      const now = new Date();
      for (let i=5;i>=0;i--) {
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        labels.push(d.toLocaleString('default',{month:'short', year:'2-digit'}));
      }
      labels.forEach((lab, idx) => {
        const start = new Date(now.getFullYear(), now.getMonth()-5+idx, 1);
        const end = new Date(start.getFullYear(), start.getMonth()+1, 1);
        const monthTotal = orders.filter(o=>{
          const t = o.createdAt ? new Date(o.createdAt) : null;
          return t && t >= start && t < end;
        }).reduce((s,o)=> s + (parseFloat(o.total)||0), 0);
        data.push(monthTotal.toFixed(2));
      });
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (window._salesChart) window._salesChart.destroy();
      window._salesChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets:[{ label:'Sales HK$', data, backgroundColor:'#d32f2f' }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
      });
    }

    function exportOrdersCsv(){
      const orders = parseJSON('orders');
      if (!orders.length) return alert('No orders to export');
      const rows = [['id','customer','total','status','deliveryDate','createdAt','message']];
      orders.forEach(o=> rows.push([o.id,o.customer, o.total, o.status || '', o.deliveryDate || '', o.createdAt || '', (o.message||'').replace(/[\r\n]+/g,' ')]));
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'orders_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // initial render + wiring
    document.addEventListener('DOMContentLoaded', ()=> {
      renderStats();
      renderChart();
      renderRecentOrders();
      renderMessages();
      // wire export
      document.getElementById('exportCsvBtn').addEventListener('click', exportOrdersCsv);
    });

    // refresh on storage changes (staff updates)
    window.addEventListener('storage', (e)=>{
      if (!e.key || e.key === 'orders') {
        renderStats(); renderChart(); renderRecentOrders(); renderMessages();
      }
    });
  </script>
</body>
</html>