<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout</title>
  <link rel="stylesheet" href="./css/main.css"/>
  <link rel="stylesheet" href="./css/animations.css"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="./js/checkout.js"></script>
  <style>
    /* compact message box styles (matches wishlist look) */
    .message-box {
      margin: 12px 0;
      padding: 10px;
      border-radius: 8px;
      background: #fff8f8;
      border: 1px solid rgba(211,47,47,0.06);
    }
    .message-box label {
      display: block;
      font-weight: 700;
      color: #b71c1c;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }
    .message-box textarea {
      width: 100%;
      min-height: 72px;
      resize: vertical;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e6e6e6;
      font-size: 0.95rem;
      box-sizing: border-box;
      background: #fff;
    }
    .message-box .hint {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:0.85rem;
      color:#666;
    }
    .message-box .char-count {
      color:#999;
      font-size:0.85rem;
    }
    .place-order-btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      background: #4caf50;
      color: white;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="customer_dashboard.html" class="navbar-brand">Smile & Sunshine</a>
      <div class="navbar-nav">
        <a href="browse_toys.html" class="nav-item">Browse Toys</a>
        <a href="wishlist.html" class="nav-item">My Wish-list</a>
        <a href="track_order.html" class="nav-item">Track Order</a>
        <a href="account.html" class="nav-item">Update Profile</a>
        <a href="quotation_form.html" class="nav-item">Custom Toys</a>
        <a href="#" onclick="logout(); return false;" class="nav-item">Logout</a>
      </div>
    </div>
  </nav>
  <div class="card fade-in" style="max-width:600px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
    <h2>Checkout</h2>
    <table id="sumTable" style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f5f5f5;">
          <th style="padding: 10px; border: 1px solid #ddd;">Toy</th>
          <th style="padding: 10px; border: 1px solid #ddd;">Price (HK$)</th>
          <th style="padding: 10px; border: 1px solid #ddd;">Quantity</th>
          <th style="padding: 10px; border: 1px solid #ddd;">Sub-total (HK$)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p style="text-align: right; font-weight: bold; margin-bottom: 20px;">Total: HK$ <span id="sumTotal">0.00</span></p>
      <div class="form-group" style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px;">Delivery Address</label>
      <input type="text" id="address" placeholder="Flat, Street, District" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <div class="error" style="color: red; display: none;"></div>
    </div>
    <div class="form-group" style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px;">Payment Method</label>
      <select id="payment" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="credit">Credit Card</option>
        <option value="fps">FPS</option>
        <option value="cod">Cash on Delivery</option>
      </select>
    </div>
    <div id="paymentDetails" style="display: none; margin-bottom: 15px;">
      <div id="creditCardDetails">
        <label style="display: block; margin-bottom: 5px;">Name on Card</label>
        <input type="text" id="creditName" placeholder="Name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <label style="display: block; margin-bottom: 5px;">Card Number</label>
        <input type="text" id="creditCardNumber" placeholder="Card Number" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <label style="display: block; margin-bottom: 5px;">Expiry Date</label>
        <input type="text" id="creditExpiry" placeholder="MM/YY" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <label style="display: block; margin-bottom: 5px;">CVV</label>
        <input type="text" id="creditCV" placeholder="CVV" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div id="fpsDetails">
        <label style="display: block; margin-bottom: 5px;">FPS Number</label>
        <input type="text" id="fpsNumber" placeholder="FPS Number" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
    </div>
    <div class="message-box">
      <label for="orderMessage">Message to Department (colors, sizes, notes)</label>
      <textarea id="orderMessage" maxlength="500" placeholder="Any special requests? (optional, max 500 chars)"></textarea>
      <div class="hint">
        <span style="color:#d32f2f;font-weight:600">Optional</span>
        <span class="char-count"><span id="orderMsgCount">0</span>/500</span>
      </div>
    </div>
    <button class="btn place-order-btn" id="placeOrderBtn" onclick="saveAndPlaceOrder()" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Place Order</button>
    <p style="text-align: center; margin-top: 15px;"><a href="wishlist.html" style="color: #007BFF;">← Back</a></p>
  </div>
  <script src="./js/checkout.js"></script>
  <script src="../../js/animations.js"></script>
  <script>
    $(document).ready(() => {
      $('#payment').change(function() {
        const method = $(this).val();
        if (method === 'credit') {
          $('#paymentDetails').show();
          $('#creditCardDetails').show();
          $('#fpsDetails').hide();
        } else if (method === 'fps') {
          $('#paymentDetails').show();
          $('#creditCardDetails').hide();
          $('#fpsDetails').show();
        } else {
          $('#paymentDetails').hide();
        }
      }).trigger('change');});
  </script> 
  <script>
    function logout() {
      sessionStorage.removeItem('user');
      location.href = 'login.html';
    }
  </script>
  <script>
    (function(){
      const wishlistKey = 'wishlistMessage';
      const orderKey = 'orderMessage';
      const ta = document.getElementById('orderMessage');
      const maxLen = 500;

      function getEl(id){ return document.getElementById(id); }

      // load prior wishlist message (if user moved from wishlist), else load any saved orderMessage
      function loadMessage(){
        const savedWishlist = localStorage.getItem(wishlistKey);
        const savedOrder = localStorage.getItem(orderKey);
        const textarea = getEl('orderMessage');
        const count = getEl('orderMsgCount');
        if (!textarea) return;
        if (savedWishlist) {
          textarea.value = savedWishlist;
          // optionally clear wishlist message if you want: localStorage.removeItem(wishlistKey);
        } else if (savedOrder) {
          textarea.value = savedOrder;
        } else {
          textarea.value = '';
        }
        if (count) count.textContent = textarea.value.length;
      }

      function saveMessage(){
        const textarea = getEl('orderMessage');
        if (!textarea) return;
        const val = textarea.value.slice(0, maxLen);
        localStorage.setItem(orderKey, val);
        // if you want to remove wishlist copy after moving:
        // localStorage.removeItem(wishlistKey);
      }

      // Place order implementation — collects table rows, validates fields, saves order to localStorage and redirects
      function placeOrder() {
        // validate address
        const addressEl = document.getElementById('address');
        const paymentEl = document.getElementById('payment');
        const totalEl = document.getElementById('sumTotal');
        const tbody = document.querySelector('#sumTable tbody');

        if (!addressEl || !paymentEl || !totalEl || !tbody) {
          alert('Checkout data missing. Please return to cart.');
          return;
        }

        const address = addressEl.value.trim();
        if (!address) {
          alert('Please enter delivery address.');
          addressEl.focus();
          return;
        }

        const payment = paymentEl.value;
        if (!payment) {
          alert('Please select a payment method.');
          paymentEl.focus();
          return;
        }

        // gather items from table
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) {
          alert('No items to place an order.');
          return;
        }

        const items = rows.map(r => {
          const cols = r.querySelectorAll('td');
          return {
            name: (cols[0] && cols[0].textContent.trim()) || '',
            price: parseFloat((cols[1] && cols[1].textContent.replace(/[^\d.-]/g,'').trim()) || 0) || 0,
            qty: parseInt((cols[2] && cols[2].textContent.trim()) || 0, 10) || 0,
            subtotal: parseFloat((cols[3] && cols[3].textContent.replace(/[^\d.-]/g,'').trim()) || 0) || 0
          };
        });

        const total = parseFloat(totalEl.textContent) || items.reduce((s,i)=>s+i.subtotal,0);

        // order message
        const message = (document.getElementById('orderMessage') && document.getElementById('orderMessage').value.trim()) || '';

        // customer info
        const user = JSON.parse(sessionStorage.getItem('user')) || {};
        const customerEmail = user.email || 'guest';

        // create order object
        const orderId = 'ORD' + Date.now();
        const order = {
          id: orderId,
          customer: customerEmail,
          items: items,
          total: total,
          address: address,
          paymentMethod: payment,
          message: message,
          status: 'pending',
          createdAt: new Date().toISOString()
        };

        // persist
        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));

        // optional: clear cart/wishlist keys commonly used by the app
        try {
          localStorage.removeItem('cart'); // common cart key
          localStorage.removeItem('wishlist'); // common wishlist key
          localStorage.removeItem('wishlistMessage'); // older temporary message
        } catch (e) { /* ignore */ }

        // persist final order message key if desired
        localStorage.setItem('orderMessage', message);

        // redirect to a success page if exists, else to customer dashboard
        if (location.pathname.toLowerCase().includes('order_confirmation.html')) {
          // try redirect to order_success.html, fallback to dashboard
          const successUrl = 'order_success.html';
          // if order_success exists on your site, uncomment redirect; else use dashboard.
          // location.href = successUrl;
          alert('Order placed successfully! Order ID: ' + orderId);
          location.href = 'customer_dashboard.html';
        } else {
          alert('Order placed successfully! Order ID: ' + orderId);
          location.href = 'customer_dashboard.html';
        }
      }

      // wrapper used by Place Order
      window.saveAndPlaceOrder = function(){
        // save message already done earlier; call placeOrder() to perform order creation
        // ensure message saved
        (function saveMessageLocal(){
          const txt = document.getElementById('orderMessage');
          if (txt) localStorage.setItem('orderMessage', txt.value.slice(0,500));
        })();
        placeOrder();
      };

      // live char count
      document.addEventListener('DOMContentLoaded', function(){
        loadMessage();
        const textarea = getEl('orderMessage');
        const count = getEl('orderMsgCount');
        if (textarea) {
          textarea.addEventListener('input', function(){
            if (textarea.value.length > maxLen) textarea.value = textarea.value.slice(0, maxLen);
            if (count) count.textContent = textarea.value.length;
          });
        }
      });
    })();
  </script>
</body>
</html>